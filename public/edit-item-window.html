<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Edit Items List</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <link rel="stylesheet" href="edit-item-window.css">

    <script>
        var firstRow = document.querySelector(".first-row")

        function receiveMessage(event) {
            console.log(event.data)
            for (var i = 0; i < event.data.length; i++) {
                // if (event.data[i] !== "" && event.data[i] !== "edit items") {
                    firstRow.insertAdjacentHTML("afterend", `
                        <div class="options-row">
                            <input class="normal-item" value=${event.data[i]} type="text">
                            <div class="minus-sign" onclick="handleMinusClick(this)"></div>
                        </div>
                    `)
                // }
            }
                
        }

        window.addEventListener("message", receiveMessage, false)  
    </script>
</head>
<body>
    <div class="first-row">
        <input class="new-item-input" type="text">
        <div class="add-sign"></div>
    </div>

    <div class="options-row">
        <input class="normal-item" value="" type="text">
        <div class="minus-sign" onclick="handleMinusClick(this)"></div>
    </div>
    <div class="options-row">
        <input class="normal-item" value="" type="text">
        <div class="minus-sign" onclick="handleMinusClick(this)"></div>
    </div>
    <!-- <div class="options-row">
        <input class="normal-item" value="" type="text">
        <div class="minus-sign" onclick="handleMinusClick(this)"></div>
    </div> -->

    <div class="buttons-row">
        <button class="save-but">Save</button>
        <button class="cancel-but">Cancel</button>
    </div>

    <script>
        function handleMinusClick(eventTarget){
            console.log(eventTarget)
            eventTarget.parentNode.parentNode.removeChild(eventTarget.parentNode)
            // So bascially onclick that is directly on the element does not pass the event object to the handler function
            // It passess event.target directly only if "this" is specified as a parameter to be passed in
            // Conclusion : onclick only calls the handler without passing anything while event listener is passed the e object
        }

        var firstRow = document.querySelector(".first-row")
        var newItemInput = document.querySelector(".new-item-input")
        var addSign = document.querySelector(".add-sign")
        var saveBut = document.querySelector(".save-but")
        var cancelBut = document.querySelector(".cancel-but")
        newItemInput.select() 

        window.addEventListener('keypress', function (e) {
            if (e.keyCode == 13) {  
                firstRow.insertAdjacentHTML("afterend", `
                    <div class="options-row">
                        <input class="normal-item" value="${newItemInput.value ? newItemInput.value : ""}" type="text">
                        <div class="minus-sign" onclick="handleMinusClick(this)"></div>
                    </div>
                `)
                newItemInput.value = ""
                newItemInput.select()
            }
        }, false)


        addSign.addEventListener("click", function(e){
            // if(e.target.parentNode.firstElementChild.value){
                firstRow.insertAdjacentHTML("afterend", `
                    <div class="options-row">
                        <input class="normal-item" value="${newItemInput.value? newItemInput.value: ""}" type="text">
                        <div class="minus-sign" onclick="handleMinusClick(this)"></div>
                    </div>
                `)
                newItemInput.value = ""
            // }
            newItemInput.select()
        })   
        cancelBut.addEventListener("click", function (e){
            window.close()
        })
        saveBut.addEventListener("click", function (e) {
            var newOptions = []
            var normalItems = document.getElementsByClassName("normal-item")
            for(var i = 0; i < normalItems.length; i++){
                newOptions[i] = normalItems[i].value
            }
            window.opener.postMessage(newOptions, "*")
            window.close()
        })
        
    </script>

</body>
</html>