<html>

<head>
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://trello.com/1/client.js?key=aa0f9cf4d2d738632836aa054dcdda43"></script>
  <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
  <style>
    #MyanmarMap {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="MyanmarMap"></div>

  <script>
    var t = window.TrelloPowerUp.iframe()

    function initMap() {
      var mapMarkersList = []
      var labels = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'

      var map = new google.maps.Map(document.getElementById('MyanmarMap'), {
        zoom: 6,
        center: { lat: 21.916221, lng: 95.955974 }
      })

      window.Trello.authorize({
        type: 'popup',
        name: 'Getting Started Application',
        scope: {
          read: 'true',
          write: 'true'
        },
        expiration: 'never',
        success: function () {
          console.log('Successful authentication')
        },
        error: function () {
          console.log('Failed authentication')
        }
      })
      //Check later whether you can take out the above authentication because you already did it in the index.html iframe

      t.cards("id").then(function (ids) {
        ids.forEach(function (id) {
          Trello.get(`cards/${id.id}/pluginData`, function (pluginData) {
            Trello.get(`cards/${id.id}/list`, function (list) {
              t.get("board", "shared", "listToColorMapper").then(function (mapper) {
                var cardCoords = JSON.parse(pluginData[0].value).coords
                if (cardCoords) {
                  var marker = new google.maps.Marker(
                    {
                      position: {
                        lng: Number(cardCoords.longitude),
                        lat: Number(cardCoords.latitude)
                      },
                      map: map,
                      icon: {
                        url: `http://maps.google.com/mapfiles/ms/icons/${mapper[list.name]}-dot.png`
                      }
                    }
                  )
                }
              })
            })
          })
        })
      })
    }
  </script>


  <script
    src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBUapN3kozFMAp4SOwmpU4e6eVqDZD_DEU&callback=initMap"></script>
</body>

</html>