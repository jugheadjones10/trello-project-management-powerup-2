<html>

<head>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://trello.com/1/client.js?key=aa0f9cf4d2d738632836aa054dcdda43"></script>
    <link rel="stylesheet" href="https://trello.com/power-ups/power-up.css">
    <link rel="stylesheet" href="costs-recording.css">
    <style>
        /* To counter trello styling which gives select a margin-bottom of 1em */
        select {
            margin-bottom: 0px;
            background: #EDEFF0;
            border-radius: 3px;
            border: 1px solid #798D99;
            box-sizing: border-box;
        }

        /* Roundabout selector below in order for it to take priority over Trello's CSS */
        div > input[type=number], div > .name-select1{
            padding: 0;
        }
    </style>

    <script>
    </script>
</head>

<body>
    <div class="grid-daddy">
        <div class="name">Item</div>
        <div class="cost">Unit Cost</div>
        <div class="quantity">Quantity</div>

        <div class="calculated-total-cost">Calculated Total Cost</div>

        <div class="actual-total-cost">Actual Total Cost</div>

        <div class="theDifference">Difference</div>

        <div class="estimated-total-cost">Estimated Total Cost</div>

        <div class="row1">
            <select class="name-select1">
                <option value=""></option>
                <option value="edit items">edit items</option>
            </select>
            <input class="cost-input1" type="number">
            <input class="quantity-input1" type="number">
            <input class="calculated-total-cost-input1" type="number" value="0" readonly>
            <input class="actual-total-cost-input1" type="number" value="0">
            <input class="difference-input1" type="number" value="0" readonly>
            <input class="estimated-total-cost-input1" type="number" value="0">
        </div>

    </div>

    <div class="bottom-row">
        <button class="add-row-button">Add row</button>
        <div class="filler"></div>
        <div class="filler"></div>

        <input class="total-total-calculated-cost" type="number" readonly>
        <input class="total-total-actual-cost" type="number" readonly>
        <input class="totalDifference" type="number" readonly>
        <input class="total-total-estimated-cost" type="number" readonly>
    </div>

    <!-- <div class="budget-exceed-report">
        <div class="budget-exceed-surplus-deficit">Budget surplus/deficit</div>
        <input class="budget-exceed-amount" type="number" readonly> 
    </div> -->

    <textarea class="comments-section" rows="10" cols="100"></textarea>

   
    <script>
        var t = window.TrelloPowerUp.iframe()

        var rowNo = 2
        var addRowBut = document.querySelector(".add-row-button")
        var gridDaddy = document.querySelector(".grid-daddy")
        addRowBut.addEventListener("click", addRow)
        addEventListeners()

        function receiveMessage(event) {
            var nameSelectInputs2 = document.getElementsByClassName("name-select1")
            var newOptions = '<option value=""></option><option value="edit items">edit items</option>'
            for(var i = 0; i < nameSelectInputs2.length; i++){
                while(nameSelectInputs2[i].firstChild) {
                    nameSelectInputs2[i].removeChild(nameSelectInputs2[i].firstChild)
                }
                for(var z = 0; z < event.data.length; z++) {
                    newOptions += `<option value="${event.data[z]}">${event.data[z]}</option>`
                }
                nameSelectInputs2[i].insertAdjacentHTML("beforeend", newOptions)
                window.updatedItems = event.data
                window.updatedHTMLItems = newOptions
                newOptions = '<option value=""></option><option value="edit items">edit items</option>'
            }
            console.log(event.data)
        }
        window.addEventListener("message", receiveMessage, false)   

        function addRow(e) {
            var templateOptions = '<option value=""></option><option value="edit items">edit items</option>'
            if(window.updatedHTMLItems){
                templateOptions = ''
            }
            if(!window.updatedHTMLItems){
                window.updatedHTMLItems = ""
            }
            gridDaddy.insertAdjacentHTML("beforeend", `
            <div class="row${rowNo}">
                <select class="name-select1">
                    ${templateOptions}
                    ${window.updatedHTMLItems}
                </select>
                <input class="cost-input1" type="number">
                <input class="quantity-input1" type="number">
                <input class="calculated-total-cost-input1" type="number" value="0" readonly>
                <input class="actual-total-cost-input1" type="number" value="0">
                <input class="difference-input1" type="number" value="0" readonly>
                <input class="estimated-total-cost-input1" type="number" value="0">
            </div>
            `)

            //Changing grid CSS to accomodate new row
            gridDaddy.style.gridTemplateRows = "35px ".repeat(1 + rowNo)
            var newGridArea = ` "name cost quantity calculated-total-cost actual-total-cost theDifference estimated-total-cost" `
            for (var i = 1; i < rowNo + 1; i++) {
                newGridArea = newGridArea + `"row${i} row${i} row${i} row${i} row${i}  row${i}  row${i}"`
            }
            gridDaddy.style.gridTemplateAreas = newGridArea
            var newRow = document.querySelector(`.row${rowNo}`)
            newRow.style.gridArea = `row${rowNo}`
            newRow.style.display = "flex"
            newRow.style.flexDirection = "row"
            ///////////////////////////////////////////
            rowNo += 1

            // Adding event listeners to all rows
            addEventListeners()
        }

        function addEventListeners() {
            var costInputs = document.getElementsByClassName("cost-input1")
            var quantInputs = document.getElementsByClassName("quantity-input1")
            var calculatedTotalCostInputs = document.getElementsByClassName("calculated-total-cost-input1")
            var actualTotalCostInputs = document.getElementsByClassName("actual-total-cost-input1")
            var difference = document.getElementsByClassName("difference-input1")
            var estimatedTotalCostInputs = document.getElementsByClassName("estimated-total-cost-input1")


            var totalTotalCalculatedCost = document.querySelector(".total-total-calculated-cost")
            var totalTotalActualCost = document.querySelector(".total-total-actual-cost")
            var totalDifference = document.querySelector(".totalDifference")
            var totalTotalEstimatedCost = document.querySelector(".total-total-estimated-cost")
            var nameSelectInputs = document.getElementsByClassName("name-select1")

            function handleCost(e) {
                calculatedTotalCostInputs[e.target.index].value = e.target.value * quantInputs[e.target.index].value
                //////////////////////////////
                var total = 0
                var totalDiff = 0
                for(var i = 0; i < calculatedTotalCostInputs.length; i++){
                    total += parseInt(calculatedTotalCostInputs[i].value, 10)
                    totalDiff += parseInt(difference[i].value, 10)
                }
                totalTotalCalculatedCost.value = total
                totalDifference.value = totalDiff
                //////////////////////////////
                difference[e.target.index].value =  calculatedTotalCostInputs[e.target.index].value -  actualTotalCostInputs[e.target.index].value
                //////////////////////////////
            }

            function handleQuant(e) {
                calculatedTotalCostInputs[e.target.index].value = e.target.value * costInputs[e.target.index].value
                //////////////////////////////
                var total = 0
                var totalDiff = 0
                for(var i = 0; i < calculatedTotalCostInputs.length; i++){
                    total += parseInt(calculatedTotalCostInputs[i].value, 10)
                    totalDiff += parseInt(difference[i].value, 10)
                }
                totalTotalCalculatedCost.value = total
                totalDifference.value = totalDiff
                //////////////////////////////
                difference[e.target.index].value =  calculatedTotalCostInputs[e.target.index].value -  actualTotalCostInputs[e.target.index].value
                //////////////////////////////
            }

            function handleChangeItem(e) {
                if (e.target.value == "edit items") {
                    var editItemWindow = window.open('edit-item-window.html', null, "height=300, width=155, toolbar=no")
                    if(window.updatedHTMLItems){

                        // function popupReceiveMessage(event) {
                        //     for(var i = 0; i < event.data.length; i++){
                        //         if(event.data[i] !== "" && event.data[i] !== "edit items"){
                        //             editItemWindow.firstRow.insertAdjacentHTML("afterend", `
                        //                 <div class="options-row">
                        //                     <input class="normal-item" value=${event.data[i]} type="text">
                        //                     <div class="minus-sign" onclick="handleMinusClick(this)"></div>
                        //                 </div>
                        //             `)
                        //         }
                        //     }
                        //     editItemWindow.console.log(event.data)
                        // }

                        // editItemWindow.addEventListener("message", popupReceiveMessage, false) 
                        editItemWindow.onload = function(){
                            editItemWindow.postMessage(window.updatedItems, "*")  
                        }
                    }
                    e.target.value = ""
                }
            }

            function handleEstimatedTotalCost(e){
                var total = 0
                for(var i = 0; i < estimatedTotalCostInputs.length; i++){
                    total += parseFloat(estimatedTotalCostInputs[i].value)
                }
                totalTotalEstimatedCost.value = total
            }

            function handleActualTotalCost(e){
                difference[e.target.index].value =  calculatedTotalCostInputs[e.target.index].value - actualTotalCostInputs[e.target.index].value

                var total = 0
                var totalDiff = 0
                for(var i = 0; i < actualTotalCostInputs.length; i++){
                    total += parseFloat(actualTotalCostInputs[i].value)
                    totalDiff += parseInt(difference[i].value, 10)
                }
                totalTotalActualCost.value = total
                totalDifference.value = totalDiff
            }

            for (var i = 0; i < costInputs.length; i++) {
                costInputs[i].index = i
                quantInputs[i].index = i
                actualTotalCostInputs[i].index = i

                costInputs[i].addEventListener('input', handleCost)
                quantInputs[i].addEventListener('input', handleQuant)
                // If anonymous functions are used, costInputs[i] and quantInputs[i] aren't defined. Maybe anon function can't access
                // the i variable?

                nameSelectInputs[i].addEventListener("input", handleChangeItem)

                // calculatedTotalCostInputs[i].addEventListener("change", handlecalculatedTotalCost)
                // Because the calculated total cost inputs are read only, the event handler for "change" isn't called
                // when its value is updated by changes in quant or price.
                actualTotalCostInputs[i].addEventListener("input", handleActualTotalCost)
                actualTotalCostInputs[i].addEventListener("click", function(e){
                    e.target.select()
                })

                estimatedTotalCostInputs[i].addEventListener("input", handleEstimatedTotalCost)
                estimatedTotalCostInputs[i].addEventListener("click", function(e){
                    e.target.select()
                })
            }
        }
    </script>

</body>

</html>